<!DOCTYPE html>
<html>
<head>
    <title>Create Form</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <main class="page">
        <header class="topbar reveal">
            <a class="brand" href="/home">
                <span class="brand-badge">FB</span>
                <span>FeedSmart</span>
            </a>
            <nav class="nav-links">
                <span class="user-pill">@{{ current_username }}</span>
                <button type="button" class="btn btn-secondary theme-toggle" onclick="toggleTheme()">Theme</button>
                <a href="/home" class="btn-link btn btn-secondary">Home</a>
                <a href="/logout" class="btn-link btn btn-secondary">Logout</a>
            </nav>
        </header>

        <section class="hero reveal delay-1">
            <h2>Create a New Form</h2>
            <p>Build rich feedback forms with short text, long text, rating, multiple choice, and checkboxes.</p>
        </section>

        <section class="section reveal delay-2">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert {{ 'alert-error' if category == 'error' else 'alert-success' }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="post" class="form-shell">
                <div class="field">
                    <label for="title">Form title</label>
                    <input id="title" name="title" placeholder="e.g. Product launch feedback" required>
                </div>
                <div class="field">
                    <label for="closing_at">Closing date (optional)</label>
                    <input id="closing_at" type="datetime-local" name="closing_at">
                    <small class="hint">After this date/time, submissions will be blocked automatically.</small>
                </div>

                <div>
                    <h3 class="section-title">Questions</h3>
                    <div class="actions">
                        <button type="button" class="btn btn-secondary" onclick="addQ('text')">Short Text</button>
                        <button type="button" class="btn btn-secondary" onclick="addQ('longtext')">Long Text</button>
                        <button type="button" class="btn btn-secondary" onclick="addQ('rating')">Rating (1-5)</button>
                        <button type="button" class="btn btn-secondary" onclick="addQ('mcq')">Multiple Choice</button>
                        <button type="button" class="btn btn-secondary" onclick="addQ('checkbox')">Checkboxes</button>
                        <button id="ai-starter-btn" type="button" class="btn btn-accent" onclick="addStarterQuestions()">Generate Starter Questions</button>
                    </div>
                    <div id="questions" class="form-shell"></div>
                </div>

                <div class="actions">
                    <button type="submit" class="btn btn-primary">Save Form</button>
                </div>
            </form>
        </section>
    </main>

<script>
function questionCard(type = 'text', text = '', options = '') {
    const needsOptions = type === 'mcq' || type === 'checkbox';
    const safeText = escapeHtml(text);
    const safeOptions = escapeHtml(options);
    return `
        <div class="question-card reveal delay-3">
            <div class="field">
                <label>Question text</label>
                <input name="question" placeholder="Type your question" required value="${safeText}">
            </div>
            <div class="field">
                <label>Type</label>
                <select name="type" onchange="toggleOptions(this)">
                    <option value="text" ${type === 'text' ? 'selected' : ''}>Short Text</option>
                    <option value="longtext" ${type === 'longtext' ? 'selected' : ''}>Long Text</option>
                    <option value="rating" ${type === 'rating' ? 'selected' : ''}>Rating (1-5)</option>
                    <option value="mcq" ${type === 'mcq' ? 'selected' : ''}>Multiple Choice</option>
                    <option value="checkbox" ${type === 'checkbox' ? 'selected' : ''}>Checkboxes</option>
                </select>
            </div>
            <div class="field options-field" style="${needsOptions ? '' : 'display:none;'}">
                <label>Options (comma separated)</label>
                <input name="options" placeholder="Option A, Option B, Option C" value="${safeOptions}">
            </div>
            <div class="actions">
                <button type="button" class="btn btn-secondary" onclick="removeQuestion(this)">Remove</button>
            </div>
        </div>`;
}

function addQ(type = 'text', text = '', options = '') {
    const div = document.getElementById('questions');
    div.insertAdjacentHTML('beforeend', questionCard(type, text, options));
}

function removeQuestion(button) {
    const card = button.closest('.question-card');
    if (card) card.remove();
}

function toggleOptions(selectEl) {
    const card = selectEl.closest('.question-card');
    if (!card) return;
    const field = card.querySelector('.options-field');
    if (!field) return;
    field.style.display = (selectEl.value === 'mcq' || selectEl.value === 'checkbox') ? '' : 'none';
}

function defaultStarterQuestions() {
    return [
        {type: 'rating', text: 'How satisfied are you with your overall experience?', options: ''},
        {type: 'mcq', text: 'Which area needs the most improvement?', options: 'Service, Quality, Pricing, Support'},
        {type: 'longtext', text: 'What did you like the most?', options: ''},
        {type: 'checkbox', text: 'Which features did you use?', options: 'Website, Mobile App, Customer Support, In-store'},
        {type: 'text', text: 'Any additional suggestions?', options: ''},
    ];
}

function escapeHtml(value) {
    return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
}

function renderQuestions(questions) {
    const div = document.getElementById('questions');
    div.innerHTML = '';
    questions.forEach((q) => addQ(q.type, q.text, q.options || ''));
}

function addDefaultStarterQuestions() {
    renderQuestions(defaultStarterQuestions());
}

async function addStarterQuestions() {
    const title = (document.getElementById('title').value || '').trim();
    if (!title) {
        alert('Enter a form title first so AI can generate relevant questions.');
        return;
    }

    const btn = document.getElementById('ai-starter-btn');
    const originalText = btn ? btn.textContent : '';
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'Generating...';
    }

    try {
        const response = await fetch('/api/starter-questions', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({title}),
        });
        const data = await response.json();
        if (!response.ok || !data.ok || !Array.isArray(data.questions)) {
            throw new Error(data.error || 'Unable to generate questions right now.');
        }
        renderQuestions(data.questions);
        if (data.warning) {
            alert(data.warning);
        }
    } catch (err) {
        addDefaultStarterQuestions();
        alert(err.message || 'AI generation failed. Loaded default starter questions.');
    } finally {
        if (btn) {
            btn.disabled = false;
            btn.textContent = originalText || 'Generate Starter Questions';
        }
    }
}

function applyTheme(mode) {
    document.body.classList.toggle('dark-theme', mode === 'dark');
    const btn = document.querySelector('.theme-toggle');
    if (btn) btn.textContent = mode === 'dark' ? 'Light Mode' : 'Dark Mode';
}

function toggleTheme() {
    const current = localStorage.getItem('theme') === 'dark' ? 'dark' : 'light';
    const next = current === 'dark' ? 'light' : 'dark';
    localStorage.setItem('theme', next);
    applyTheme(next);
}

applyTheme(localStorage.getItem('theme') === 'dark' ? 'dark' : 'light');
addDefaultStarterQuestions();
</script>
</body>
</html>

