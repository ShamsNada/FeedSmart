<!DOCTYPE html>
<html>
<head>
    <title>Edit Form</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <main class="page">
        <header class="topbar reveal">
            <a class="brand" href="/home">
                <span class="brand-badge">FB</span>
                <span>FeedSmart</span>
            </a>
            <nav class="nav-links">
                <span class="user-pill">@{{ current_username }}</span>
                <button type="button" class="btn btn-secondary theme-toggle" onclick="toggleTheme()">Theme</button>
                <a href="/home" class="btn-link btn btn-secondary">Home</a>
                <a href="/logout" class="btn-link btn btn-secondary">Logout</a>
            </nav>
        </header>

        <section class="hero reveal delay-1">
            <h2>Edit Form</h2>
            <p>Update title and question flow for {{ form.title }}.</p>
        </section>

        <section class="section reveal delay-2">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert {{ 'alert-error' if category == 'error' else 'alert-success' }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="post" class="form-shell">
                <div class="field">
                    <label for="title">Form title</label>
                    <input id="title" name="title" value="{{ form.title }}" required>
                </div>
                <div class="field">
                    <label for="closing_at">Closing date (optional)</label>
                    <input
                        id="closing_at"
                        type="datetime-local"
                        name="closing_at"
                        value="{{ form.closing_at.strftime('%Y-%m-%dT%H:%M') if form.closing_at else '' }}"
                    >
                    <small class="hint">Leave empty to keep this form open forever.</small>
                </div>

                <div>
                    <h3 class="section-title">Questions</h3>
                    <div class="actions">
                        <button type="button" class="btn btn-secondary" onclick="addQ('text')">Short Text</button>
                        <button type="button" class="btn btn-secondary" onclick="addQ('longtext')">Long Text</button>
                        <button type="button" class="btn btn-secondary" onclick="addQ('rating')">Rating (1-5)</button>
                        <button type="button" class="btn btn-secondary" onclick="addQ('mcq')">Multiple Choice</button>
                        <button type="button" class="btn btn-secondary" onclick="addQ('checkbox')">Checkboxes</button>
                        <button type="button" class="btn btn-accent" onclick="addStarterQuestions()">Generate Starter Questions</button>
                    </div>
                    <div id="questions" class="form-shell"></div>
                </div>

                <div class="actions">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </section>
    </main>

<script>
function questionCard(type = 'text', text = '', options = '') {
    const needsOptions = type === 'mcq' || type === 'checkbox';
    return `
        <div class="question-card reveal delay-3">
            <div class="field">
                <label>Question text</label>
                <input name="question" placeholder="Type your question" required value="${text}">
            </div>
            <div class="field">
                <label>Type</label>
                <select name="type" onchange="toggleOptions(this)">
                    <option value="text" ${type === 'text' ? 'selected' : ''}>Short Text</option>
                    <option value="longtext" ${type === 'longtext' ? 'selected' : ''}>Long Text</option>
                    <option value="rating" ${type === 'rating' ? 'selected' : ''}>Rating (1-5)</option>
                    <option value="mcq" ${type === 'mcq' ? 'selected' : ''}>Multiple Choice</option>
                    <option value="checkbox" ${type === 'checkbox' ? 'selected' : ''}>Checkboxes</option>
                </select>
            </div>
            <div class="field options-field" style="${needsOptions ? '' : 'display:none;'}">
                <label>Options (comma separated)</label>
                <input name="options" placeholder="Option A, Option B, Option C" value="${options}">
            </div>
            <div class="actions">
                <button type="button" class="btn btn-secondary" onclick="removeQuestion(this)">Remove</button>
            </div>
        </div>`;
}

function addQ(type = 'text', text = '', options = '') {
    const div = document.getElementById('questions');
    div.insertAdjacentHTML('beforeend', questionCard(type, text, options));
}

function removeQuestion(button) {
    const card = button.closest('.question-card');
    if (card) card.remove();
}

function toggleOptions(selectEl) {
    const card = selectEl.closest('.question-card');
    if (!card) return;
    const field = card.querySelector('.options-field');
    if (!field) return;
    field.style.display = (selectEl.value === 'mcq' || selectEl.value === 'checkbox') ? '' : 'none';
}

function addStarterQuestions() {
    const starter = [
        {type: 'rating', text: 'How satisfied are you with your overall experience?', options: ''},
        {type: 'mcq', text: 'Which area needs the most improvement?', options: 'Service, Quality, Pricing, Support'},
        {type: 'longtext', text: 'What did you like the most?', options: ''},
        {type: 'checkbox', text: 'Which features did you use?', options: 'Website, Mobile App, Customer Support, In-store'},
        {type: 'text', text: 'Any additional suggestions?', options: ''},
    ];
    const div = document.getElementById('questions');
    div.innerHTML = '';
    starter.forEach((q) => addQ(q.type, q.text, q.options));
}

function applyTheme(mode) {
    document.body.classList.toggle('dark-theme', mode === 'dark');
    const btn = document.querySelector('.theme-toggle');
    if (btn) btn.textContent = mode === 'dark' ? 'Light Mode' : 'Dark Mode';
}

function toggleTheme() {
    const current = localStorage.getItem('theme') === 'dark' ? 'dark' : 'light';
    const next = current === 'dark' ? 'light' : 'dark';
    localStorage.setItem('theme', next);
    applyTheme(next);
}

applyTheme(localStorage.getItem('theme') === 'dark' ? 'dark' : 'light');
{% if questions %}
    {% for q in questions %}
addQ('{{ q.qtype }}', {{ q.text|tojson }}, {{ (q.options or '')|tojson }});
    {% endfor %}
{% else %}
addStarterQuestions();
{% endif %}
</script>
</body>
</html>

